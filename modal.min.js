/*!
 * CSS Modal
 * http://drublic.github.com/css-modal
 *
 * @author Hans Christian Reinl - @drublic
 */
(function(global,$){"use strict";var modal={activeElement:undefined,lastActive:undefined,stackedElements:[],tabbableElements:"a[href], area[href], input:not([disabled]),"+"select:not([disabled]), textarea:not([disabled]),"+"button:not([disabled]), iframe, object, embed, *[tabindex],"+"*[contenteditable]",on:function(event,elements,callback){var i=0;if(typeof event!=="string"){throw new Error("Type error: `event` has to be a string")}if(typeof callback!=="function"){throw new Error("Type error: `callback` has to be a function")}if(!elements){return}if(!elements.length){elements=[elements]}for(;i<elements.length;i++){if($){$(elements[i]).on(event,callback)}else if("addEventListener"in elements[i]){elements[i].addEventListener(event,callback,false)}}},trigger:function(event,modal){var eventTrigger;var eventParams={detail:{modal:modal}};if($){$(document).trigger(event,eventParams)}else if(document.createEvent){eventTrigger=document.createEvent("CustomEvent");eventTrigger.initCustomEvent(event,false,false,{modal:modal});document.dispatchEvent(eventTrigger)}else{eventTrigger=new CustomEvent(event,eventParams);document.dispatchEvent(eventTrigger)}},addClass:function(element,className){if(element&&!element.className.match(className)){element.className+=" "+className}},removeClass:function(element,className){element.className=element.className.replace(className,"").replace("  "," ")},hasClass:function(element,className){return!!element.className.match(className)},setFocus:function(){if(modal.activeElement){modal.lastActive=document.activeElement;modal.activeElement.focus();modal.keepFocus(modal.activeElement)}},removeFocus:function(){if(modal.lastActive){modal.lastActive.focus()}},keepFocus:function(element){var allTabbableElements=[];try{allTabbableElements=element.querySelectorAll(modal.tabbableElements)}catch(ex){return}var firstTabbableElement=modal.getFirstElementVisible(allTabbableElements);var lastTabbableElement=modal.getLastElementVisible(allTabbableElements);var focusHandler=function(event){var keyCode=event.which||event.keyCode;if(keyCode!==9){return}event.preventDefault=event.preventDefault||function(){event.returnValue=false};if(event.target===lastTabbableElement&&!event.shiftKey){event.preventDefault();firstTabbableElement.focus()}else if(event.target===firstTabbableElement&&event.shiftKey){event.preventDefault();lastTabbableElement.focus()}};modal.on("keydown",element,focusHandler)},getFirstElementVisible:function(nodeList){var nodeListLength=nodeList.length;if(!modal.isElementVisible(nodeList[0])){for(var i=1;i<nodeListLength-1;i++){if(modal.isElementVisible(nodeList[i])){return nodeList[i]}}}else{return nodeList[0]}return null},getLastElementVisible:function(nodeList){var nodeListLength=nodeList.length;var lastTabbableElement=nodeList[nodeListLength-1];if(!modal.isElementVisible(lastTabbableElement)){for(var i=nodeListLength-1;i>=0;i--){if(modal.isElementVisible(nodeList[i])){return nodeList[i]}}}else{return lastTabbableElement}return null},isElementVisible:function(element){return!(element.offsetWidth===0&&element.offsetHeight===0)},setActive:function(element){modal.addClass(element,"is-active");modal.activeElement=element;modal.activeElement.setAttribute("aria-hidden","false");modal.setFocus(element.id);modal.trigger("cssmodal:show",modal.activeElement)},unsetActive:function(isStacked,shouldNotBeStacked){modal.removeClass(document.documentElement,"has-overlay");if(modal.activeElement){modal.removeClass(modal.activeElement,"is-active");modal.trigger("cssmodal:hide",modal.activeElement);modal.activeElement.setAttribute("aria-hidden","true");modal.removeFocus();if(isStacked&&!shouldNotBeStacked){modal.stackModal(modal.activeElement)}if(!isStacked&&modal.stackedElements.length>0){modal.unstackModal()}modal.activeElement=null}},stackModal:function(stackableModal){modal.addClass(stackableModal,"is-stacked");modal.stackedElements.push(modal.activeElement)},unstackModal:function(){var stackedCount=modal.stackedElements.length;var lastStacked=modal.stackedElements[stackedCount-1];modal.removeClass(lastStacked,"is-stacked");global.location.hash=lastStacked.id;modal.stackedElements.splice(stackedCount-1,1)},mainHandler:function(event,noHash){var hash=global.location.hash.replace("#","");var index=0;var tmp=[];var modalElement;var modalChild;if(noHash){hash=event.currentTarget.getAttribute("href").replace("#","")}modalElement=document.getElementById(hash);if(hash.indexOf("/")!==-1){tmp=hash.split("/");index=tmp.pop();hash=tmp.join("/");modalElement=document.getElementById(hash);if(!modalElement){throw new Error('ReferenceError: element "'+hash+'" does not exist!')}modalElement.index=1*index}if(modalElement){try{event.preventDefault()}catch(ex){event.returnValue=false}modalChild=modalElement.children[0];if(modalChild&&modalChild.className.match(/modal-inner/)){modal.unsetActive(!modal.hasClass(modalElement,"is-active"),modalElement.getAttribute("data-stackable")==="false");modal.addClass(document.documentElement,"has-overlay");modal._currentScrollPositionY=global.scrollY;modal._currentScrollPositionX=global.scrollX;modal.setActive(modalElement);modal.activeElement._noHash=noHash}}else{modal.unsetActive()}return true},injectIframes:function(){var iframes=document.querySelectorAll("[data-iframe-src]");var iframe;var i=0;for(;i<iframes.length;i++){iframe=document.createElement("iframe");iframe.src=iframes[i].getAttribute("data-iframe-src");iframe.setAttribute("webkitallowfullscreen",true);iframe.setAttribute("mozallowfullscreen",true);iframe.setAttribute("allowfullscreen",true);iframes[i].appendChild(iframe)}},init:function(){this.on("keyup",document,function(event){var hash=global.location.hash.replace("#","");if(event.keyCode===27){if(modal.activeElement&&hash===modal.activeElement.id){global.location.hash="!"}else{modal.unsetActive()}if(modal.lastActive){return false}modal.removeFocus()}},false);this.on("click",document.querySelectorAll("[data-cssmodal-nohash]"),function(event){modal.mainHandler(event,true)});this.on("click",document.querySelectorAll(".modal-close"),function(event){if(modal.activeElement._noHash){modal.mainHandler(event,true)}});this.on("hashchange",global,modal.mainHandler);this.on("load",global,modal.mainHandler);global.onscroll=global.onmousewheel=function(){if(document.documentElement.className.match(/has-overlay/)){global.scrollTo(modal._currentScrollPositionX,modal._currentScrollPositionY)}};modal.injectIframes()}};if(typeof module==="object"&&module&&typeof module.exports==="object"){module.exports=modal}else if(typeof define==="function"&&define.amd){define("CSSModal",[],function(){if(!global.CustomEvent&&!$){throw new Error("This browser doesn't support CustomEvent - please include jQuery.")}modal.init();return modal})}else if(typeof global==="object"&&typeof global.document==="object"){global.CSSModal=modal;modal.init()}})(window,window.jQuery);
